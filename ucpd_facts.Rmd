---
title: "Appendix 1: University of Chicago Police Department Open Data Analysis"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    theme: sandstone
    number_sections: true
---

```{r initial_setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(kableExtra)
library(scales)
library(sf)
library(tigris)
library(tidycensus)
library(leaflet)
library(ggplot2)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#prepare data
traffic <- read_csv("files/traffic_cleaned.csv")
traffic <- traffic %>% mutate(Year = year(Date)) %>%
  filter(between(Year, 2015, 2019))

interview <- read_csv("files/interview_cleaned.csv")
interview <- interview %>% mutate(Year = year(Date)) %>%
  filter(between(Year, 2015, 2019))

incident <- read_csv("files/incident_cleaned.csv")
incident <- incident %>% mutate(Year = year(Occured)) %>%
  filter(between(Year, 2015, 2019), Outcome != "void")

traffic <- traffic %>% mutate(is_black = ifelse(Race == "African American", 1, 0))
interview <- interview %>% mutate(is_black = ifelse(Race == "African American", 1, 0),
                                  searched = ifelse(Search == "Yes", 1, 0))

#geospatial data
UCPD_area <- st_read("files/Areas_UCPD/Areas.shp")

cook_pop <-
  get_acs(geography = "tract",
        variables = c("B02001_001", "B02001_002", "B02001_003"),
        state = "17",
        county = "031",
        cache_table = TRUE,
        output = "wide",
        geometry = TRUE)
cook_pop <- cook_pop[, -grep("\\dM", colnames(cook_pop))]

cook_pop <- cook_pop %>% rename(total_pop = B02001_001E,
                                white_pop = B02001_002E,
                                black_pop = B02001_003E)
cook_pop <- st_transform(cook_pop, st_crs(UCPD_area))
```

# Introduction

UCPD releases three types of data on their data page. This data is not directly downloadable and was web scraped into a database which was then standardized. The three types of data include *[The Daily Incident Report](https://incidentreports.uchicago.edu/)*, which includes crimes and fires reported to UCPD in its patrol area, *[Traffic Stops](https://incidentreports.uchicago.edu/trafficStops.php)*, and *[Field Interviews](https://incidentreports.uchicago.edu/fieldInterviews.php)*.

Note that 2019 numbers are through December 6, 2019.

## Number of interactions with UCPD by Year
```{r}
kable(traffic %>% group_by(Year) %>% 
        summarize(Total = n(), `% African American` = percent(sum(is_black) / n(), .1)), 
      caption="Table 1: Traffic Stops") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

kable(incident %>% group_by(Year) %>% 
        summarize(Total = n()), caption="Table 2: Incidents") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

kable(interview %>% group_by(Year) %>% summarize(Total = n(), `% African American` = percent(sum(is_black) / n(), .1)), 
      caption="Table 3: Interviews") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)
```

## Traffic Outcomes

```{r}
kable(traffic %>% group_by(Year, Disposition) %>% 
  summarize(Total = n()) %>% 
  pivot_wider(names_from = c("Disposition"), values_from = Total) %>%
  mutate(Arrest = replace_na(Arrest, 0)), caption="Table 4: Traffic Outcomes") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

mini_traffic <- traffic %>% filter(Disposition != "Arrest", Race != "NHPI or Indian", `IDOT Classification` != "Other")

race_cnts <- mini_traffic %>% group_by(Race) %>% summarize(`Total (by Race)` = n())

dis_race <- mini_traffic %>% group_by(Disposition, Race) %>% 
        summarize(Total = n()) %>% left_join(race_cnts) %>%
  mutate(`Share in Category` = percent(Total / `Total (by Race)`, .1))

search_race <- mini_traffic %>% group_by(Search, Race) %>% 
        summarize(Total = n()) %>% left_join(race_cnts) %>%
  mutate(`Share in Category` = percent(Total / `Total (by Race)`, .1))

violation_race <- mini_traffic %>% group_by(`IDOT Classification`, Race) %>% 
        summarize(Total = n()) %>% left_join(race_cnts) %>%
  mutate(`Share in Category` = percent(Total / `Total (by Race)`, .1)) %>% select(-Total, -`Total (by Race)`) %>% 
  pivot_wider(names_from = c("Race"), values_from = `Share in Category`)

kable(dis_race %>% select(-`Total (by Race)`), caption="Table 5: Traffic Outcomes by Race") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

kable(search_race %>% select(-`Total (by Race)`), caption="Table 6: Traffic Search Outcomes by Race") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

kable(violation_race, caption="Table 7: Traffic Violation Outcomes by Race") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)


mini_traffic <-
  mini_traffic %>% mutate(searched = ifelse(Search == "Yes", 1, 0),
                          cited = ifelse(Disposition == "Citation", 1, 0),
                          searched_and_cited = ifelse(searched == 1 & cited == 1, 1, 0),
                          searched_and_not_cited = ifelse(searched == 1 & cited == 0, 1, 0),
                          warning = ifelse(Disposition == "Warning", 1, 0))
all_interactions <- 
  mini_traffic %>% group_by(Year, Race) %>% summarize(pct_search = sum(searched) / n(),
                                                     pct_cited = sum(cited) / n(),
                                                     pct_search_cite = sum(searched_and_cited) / n(),
                                                     pct_search_nocite = sum(searched_and_not_cited) / n(),
                                                     pct_warning = sum(warning) / n(),
                                                     count = n())
all_interactions <- all_interactions %>% mutate_at(vars(pct_search:pct_warning), percent)

kable(all_interactions, caption = "Table 8: Traffic Stop Outcomes by Race and Year") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

ggplot(mini_traffic %>% group_by(Race) %>% summarize(`Citation Rate Once Stopped` = sum(cited) / n()), aes(Race, `Citation Rate Once Stopped`)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +
  scale_y_continuous(labels=percent_format()) +
  theme(text = element_text(size=15))

ggplot(mini_traffic %>% group_by(Race) %>% summarize(`Search Rate Once Stopped` = sum(searched) / n()), aes(Race, `Search Rate Once Stopped`)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +
  scale_y_continuous(labels=percent_format()) +
  theme(text = element_text(size=15))

```





## Interview Outcomes
```{r}
mini_interview <- interview %>% filter(!is.na(Search), Race != "Hispanic")

race_cnts_interview <- mini_interview %>% group_by(Race) %>% summarize(`Total (by Race)` = n())

int_search_race <- 
  mini_interview %>% group_by(Search, Race) %>% summarize(Total = n()) %>% 
  left_join(race_cnts_interview) %>%
  mutate(`Share in Category` = percent(Total / `Total (by Race)`, .1))

int_disp_race <- 
  mini_interview %>% group_by(Disposition, Race) %>% summarize(Total = n()) %>% 
  left_join(race_cnts_interview) %>%
  mutate(`Share in Category` = percent(Total / `Total (by Race)`, .1)) %>% select(-Total, -`Total (by Race)`) %>% 
  pivot_wider(names_from = c("Race"), values_from = `Share in Category`) %>% mutate(Caucasian = replace_na(Caucasian, "0%"))

tbldata <- interview %>% group_by(`Initiated By`, Year) %>% count() %>% pivot_wider(names_from = "Year", values_from = "n")

kable(tbldata, caption = "Table 9: Interview Initiated By") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

kable(int_search_race %>% select(-`Total (by Race)`), caption="Table 10: Interview Search Outcomes by Race") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

kable(int_disp_race, caption="Table 11: Interview Disposition Outcomes by Race") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

ggplot(interview %>% filter(Race != "other") %>% group_by(Race) %>% summarize(`Number of Searches` = sum(searched)), 
       aes(Race, `Number of Searches`)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +
  theme(text = element_text(size=15))

```

## Incident Outcomes
```{r}
incident$Month <- as.Date(cut(incident$Occured,
  breaks = "month"))
ggplot(incident %>% filter(Year > 2015), aes(Month)) + geom_bar() + 
  labs(y="Number of Incidents Per Month") + theme_minimal()

outcome_by_year <- incident %>% group_by(Year) %>% count(Outcome)

ggplot(outcome_by_year %>% filter(Outcome == "arrested"), aes(Year, n)) + geom_bar(position="dodge", stat="identity") + theme_minimal() + labs(y="Arrests per Year") +
  theme(text = element_text(size=15))

ggplot(outcome_by_year %>% filter(Outcome == "closed"), aes(Year, n)) + geom_bar(position="dodge", stat="identity") + theme_minimal() + labs(y="Closed per Year") +
  theme(text = element_text(size=15))

ggplot(outcome_by_year %>% filter(Outcome == "cpd" | Outcome == "referred"), aes(Year, n)) + geom_bar(position="dodge", stat="identity") + theme_minimal() + labs(y="Referred per Year") +
  theme(text = element_text(size=15))

kable(outcome_by_year %>% pivot_wider(names_from = "Outcome", values_from = "n"), caption="Table 12: Incident Outcomes by Year") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)


```

## Gaps
```{r}
tst <- interview %>% filter(is_black==0) %>% arrange(Date) %>%
  mutate(previous = lag(Date, 1),
         day_difference = (Date - previous)/(60*60*24))

max <- tst %>% filter(day_difference == max(day_difference, na.rm=T))
```

For over half a year from 9/17/2016 to 3/10/2017, UCPD only interviewed African Americans.

# UCPD Patrol Area

```{r}
rslt <- st_join(UCPD_area, cook_pop)
rslt <- rslt %>% as.data.frame() %>% select(-geometry) %>% left_join(cook_pop %>% select(GEOID), by=c("GEOID"))
rslt <- st_transform(st_as_sf(rslt), 4326)

kable(rslt %>% as.data.frame() %>%
  summarize(`Total Population` = sum(total_pop),
                   `Total White Population` = sum(white_pop),
                   `Total Black Population` = sum(black_pop)),
  caption="Table 13: Population in Census Tracts which intersect UCPD Patrol Area") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

weighted_est <- st_interpolate_aw(cook_pop[c('total_pop', 'white_pop', 'black_pop')], UCPD_area, extensive = TRUE)
kable(weighted_est %>% as.data.frame() %>% summarize(`Total Population` = round(sum(total_pop)),
                   `Total White Population` = round(sum(white_pop)),
                   `Total Black Population` = round(sum(black_pop))),
  caption="Table 14: Projected Population in UCPD Patrol Area") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

rslt <- rslt %>% mutate(share_non_white = (total_pop - white_pop) / total_pop)

pal <- colorNumeric(palette="Blues", rslt$share_non_white, na.color="Grey")


UCPD_area <- st_transform(UCPD_area, 4326)


leaflet(width="100%") %>% addTiles() %>% 
  addPolygons(data=rslt, 
              fillColor = ~pal(share_non_white),
              weight = 2, 
              opacity = 1,
              color = "grey",
              dashArray = 3,
              fillOpacity = 0.7) %>%
  addPolygons(data=UCPD_area,
              weight =5,
              opacity =1,
              fillOpacity = 0,
              color="black") %>%
addLegend(pal = pal, values = rslt$share_non_white, 
          opacity = 0.7, title = "Share Non-White Population", position = "bottomright")


```

## Github Directory
https://github.com/erhla/UCPD

